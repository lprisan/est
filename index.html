<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/est/assets/css/style.css?v=10ade4696ae595687924e6028f819ba11c064777">
    <link rel="stylesheet" type="text/css" href="/est/assets/css/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

<!-- Begin Jekyll SEO tag v2.3.0 -->
<title> | Experience Sampling Timer</title>
<meta property="og:title" content="Experience Sampling Timer" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="EST is the acronym of "experience sampling timer", it takes as parameters an URL of a link to display in a new browser tab (e.g., the questionnaire for an experience sampling experiment), and the number of data gathering points to sound the alarm semi-randomly, in the next X minutes." />
<meta property="og:description" content="EST is the acronym of "experience sampling timer", it takes as parameters an URL of a link to display in a new browser tab (e.g., the questionnaire for an experience sampling experiment), and the number of data gathering points to sound the alarm semi-randomly, in the next X minutes." />
<link rel="canonical" href="https://lprisan.github.io/est/" />
<meta property="og:url" content="https://lprisan.github.io/est/" />
<meta property="og:site_name" content="sot" />
<script type="application/ld+json">
{"name":"sot","description":"EST is the acronym of "experience sampling timer", it takes as parameters an URL of a link to display in a new browser tab (e.g., the questionnaire for an experience sampling experiment), and the number of data gathering points to sound the alarm semi-randomly, in the next X minutes.","author":null,"@type":"WebSite","url":"https://lprisan.github.io/est/","image":null,"publisher":null,"headline":"Experience Sampling Timer","dateModified":null,"datePublished":null,"sameAs":null,"mainEntityOfPage":null,"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h2>Experience Sampling Timer</h2>
          <button id="button"  style="font-size : 30px;">Click to start</button>
          <h1 id="message">The experiment will end in <span id="timeleft"></span>. The timer has gone off <span id="datasofar"></span> ...</h1>
        </header>
        <hr>
        <section id="main_content">
<h4>Once the time goes off, you can use the <a id="link" href="http://tinyurl.com/linnaruum-observer" target="_new">provided link</a> (opens a new browser tab), or use the provided QR code (on paper).</h4>

        </section>

        <footer>

          EST is maintained by <a href="https://github.com/lprisan">lprisan</a><br>

          This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.
        </footer>

      </div>
    </div>

<script type="text/javascript">

var audioElements = document.getElementsByTagName('audio'),
    sounds = {};


function mediaPlaybackRequiresUserGesture() {
    // test if play() is ignored when not called from an input event handler
    var video = document.createElement('video');
    video.play();
    return video.paused;
}

function removeBehaviorsRestrictions() {
    for (var i = 0; i < audioElements.length; i++) {
        audioElements[i].load();
    }

    window.removeEventListener('keydown', removeBehaviorsRestrictions);
    window.removeEventListener('mousedown', removeBehaviorsRestrictions);
    window.removeEventListener('touchstart', removeBehaviorsRestrictions);
}

function playSound(sound) {
    for (var key in sounds) {
      sounds[key].pause();
    }

    sounds[sound].load();
    sounds[sound].play();
}

//returns the time in seconds until the next semi-random data gathering
function setupNextTimer(endtime, display, display2, remainingpoints, devtime, linkurl){

    var remainingtime = endtime - (new Date()).getTime(); //remaining time till end of experiment
    var expectedtimer = remainingtime/(remainingpoints+1); //time to expected next data gathering point, assuming equal intervals
    var dev=devtime*1000; //Deviation/range around expected time point
    if(devtime>(expectedtimer-1000)/2) dev = (expectedtimer-1000)/2; //If deviation is too big, at least make the deviation so that the next timer falls into the second half towards the expected time
    var timer = Math.floor(expectedtimer-dev+(Math.random()*2*dev)/1000); //Real timer until data gathering, in seconds
    var minutes, seconds;
    var link = document.getElementById('link');
    link.href = linkurl;

//        minutes = parseInt(timer / 60, 10)
//        seconds = parseInt(timer % 60, 10);
//        minutes = minutes < 10 ? "0" + minutes : minutes;
//        seconds = seconds < 10 ? "0" + seconds : seconds;
//        display.textContent = minutes + ":" + seconds;
//        display2.textContent = ""+datasofar;

        var pretitle = document.title.substring(document.title.indexOf(" | "));
        //update also the title
        document.title = minutes + ":" + seconds + " " + pretitle;

        return timer;
}

function startTimer(duration, display, display2, linkurl) {
    var timer = duration, minutes, seconds;
    var link = document.getElementById('link');
    link.href = linkurl;

    alert("starting timer for "+duration);

    setInterval(function () {
        minutes = parseInt(timer / 60, 10)
        seconds = parseInt(timer % 60, 10);
        minutes = minutes < 10 ? "0" + minutes : minutes;
        seconds = seconds < 10 ? "0" + seconds : seconds;
        display.textContent = minutes + ":" + seconds;
        display2.textContent = ""+datasofar;

        var pretitle = document.title.substring(document.title.indexOf(" | "));
        //update also the title
        document.title = minutes + ":" + seconds + " " + pretitle;

        if (--timer < 0) {
            //document.getElementById('alarm').play();
            playSound('alarm');
            datasofar++;
            var next = setupNextTimer(endtime, display, (times-datasofar), devtime, url);
            startTimer(next, display, linkurl);
        }
    }, 1000);
}

function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}

var url="http://tinyurl.com/linnaruum-observer";

function isURL(str) {
  var pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
  '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.?)+[a-z]{2,}|'+ // domain name
  '((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
  '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
  '(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
  '(\\#[-a-z\\d_]*)?$','i'); // fragment locator
  return pattern.test(str);
}

window.onload = function () {

//Potential fix?
for (var i = 0; i < audioElements.length; i++) {
    sounds[audioElements[i].className] = audioElements[i];
}
// Solves chrome for andriod issue 178297 Require user gesture
// https://code.google.com/p/chromium/issues/detail?id=178297
// Fix based on code from http://blog.foolip.org/2014/02/10/media-playback-restrictions-in-blink/
if (mediaPlaybackRequiresUserGesture()) {
    window.addEventListener('keydown', removeBehaviorsRestrictions);
    window.addEventListener('mousedown', removeBehaviorsRestrictions);
    window.addEventListener('touchstart', removeBehaviorsRestrictions);
}
///////////////


    var times = 6, // Data gathering points
    totaltime = 75*60, //Total experiment time in seconds
    devtime = Math.floor(totaltime/(2*(times+1))), //range around the regular time point, where the data gathering can happen, in seconds
    display = document.querySelector('#timeleft');
    display2 = document.querySelector('#datasofar');

    var datasofar = 0; // Number of data gathering events fired so far

    // Number of data gathering points/alarms
    if(parseInt(getParameterByName('times'))>0){
        times = parseInt(getParameterByName('times'));
    }

    // Total time of the experiment, in seconds
    if(parseInt(getParameterByName('totalmin'))>0){
        totaltime = parseInt(getParameterByName('totalmin'))*60;
    }

    // Deviation around expected point, in seconds
    if(parseInt(getParameterByName('devmin'))>0){
        devtime = parseInt(getParameterByName('devmin'))*60;
    }

    if(getParameterByName('url')!=null && isURL(decodeURIComponent(getParameterByName('url')))){
        url = decodeURIComponent(getParameterByName('url'));
    }

    //Setup where the end of the experiment will fall
    var endtime = (new Date()).getTime()+(totaltime*1000); //timestamp of the endtime

    //Update the display till the end of the experiment
    minutes = parseInt(totaltime / 60, 10)
    seconds = parseInt(totaltime % 60, 10);
    minutes = minutes < 10 ? "0" + minutes : minutes;
    seconds = seconds < 10 ? "0" + seconds : seconds;
    display.textContent = minutes + ":" + seconds;

    //Randomly decide where the next data gathering point will fall, in seconds
    var nextTimer = setupNextTimer(endtime, display, display2, (times-datasofar), devtime, url);
    document.getElementById('button').onclick=function(){document.getElementById('alarm').play();startTimer(nextTimer, display, display2, url);document.getElementById('button').disabled=true;}

};
</script>

<audio preload='preload' id='alarm' class='alarm'>
        <source src='media/alarm.ogg' type='audio/ogg' />
        <source src='media/alarm.mp3' type='audio/mpeg' />
        <source src='media/alarm.wav' type='audio/wav' />
</audio>

  </body>
</html>
