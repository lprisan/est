<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/est/assets/css/style.css?v=10ade4696ae595687924e6028f819ba11c064777">
    <link rel="stylesheet" type="text/css" href="/est/assets/css/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

<!-- Begin Jekyll SEO tag v2.3.0 -->
<title> | Experience Sampling Timer</title>
<meta property="og:title" content="Experience Sampling Timer" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="EST is the acronym of "experience sampling timer", it takes as parameters an URL of a link to display in a new browser tab (e.g., the questionnaire for an experience sampling experiment), and the number of data gathering points to sound the alarm semi-randomly, in the next X minutes." />
<meta property="og:description" content="EST is the acronym of "experience sampling timer", it takes as parameters an URL of a link to display in a new browser tab (e.g., the questionnaire for an experience sampling experiment), and the number of data gathering points to sound the alarm semi-randomly, in the next X minutes." />
<link rel="canonical" href="https://lprisan.github.io/est/" />
<meta property="og:url" content="https://lprisan.github.io/est/" />
<meta property="og:site_name" content="sot" />
<script type="application/ld+json">
{"name":"sot","description":"EST is the acronym of "experience sampling timer", it takes as parameters an URL of a link to display in a new browser tab (e.g., the questionnaire for an experience sampling experiment), and the number of data gathering points to sound the alarm semi-randomly, in the next X minutes.","author":null,"@type":"WebSite","url":"https://lprisan.github.io/est/","image":null,"publisher":null,"headline":"Experience Sampling Timer","dateModified":null,"datePublished":null,"sameAs":null,"mainEntityOfPage":null,"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h2>Experience Sampling Timer</h2>
          <button id="button"  style="font-size : 30px;">Click to start</button>
          <h1 id="message"><span id="initialmsg">Once you click the start button,</span> the experiment will end in <span id="timeleft"></span>. The timer has gone off <span id="datasofarmsg"></span> times ...</h1>
        </header>
        <hr>
        <section id="main_content">
            <div id="qr">
                <h3><a id="link2" href="https://goo.gl/FqZexS" target="_new">Please answer the questionnaire here</a></h3>
                <br />
                <img src="./assets/img/qr.png" alt="QR code for the questionnaire" width="400" />
            </div>
            <hr>
            <h4>Once the next random timer goes off, you can use the provided link (opens a new browser tab), or use the provided QR code.</h4>

        </section>

        <footer>

          EST is maintained by <a href="https://github.com/lprisan">lprisan</a><br>

          This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.
        </footer>

      </div>
    </div>

<script type="text/javascript">

var audioElements = document.getElementsByTagName('audio'),
    sounds = {};


function mediaPlaybackRequiresUserGesture() {
    // test if play() is ignored when not called from an input event handler
    var video = document.createElement('video');
    video.play();
    return video.paused;
}

function removeBehaviorsRestrictions() {
    for (var i = 0; i < audioElements.length; i++) {
        audioElements[i].load();
    }

    window.removeEventListener('keydown', removeBehaviorsRestrictions);
    window.removeEventListener('mousedown', removeBehaviorsRestrictions);
    window.removeEventListener('touchstart', removeBehaviorsRestrictions);
}

function playSound(sound) {
    for (var key in sounds) {
      sounds[key].pause();
    }

    sounds[sound].load();
    sounds[sound].play();
}

//returns the time in seconds until the next semi-random data gathering
function setupNextTimer(endtime, display, display2, remainingpoints, devtime, linkurl){

    remainingtime = endtime - (new Date()).getTime(); //remaining time till end of experiment
    var expectedtimer = remainingtime/(remainingpoints+1); //time to expected next data gathering point, assuming equal intervals
    var dev=devtime*1000; //Deviation/range around expected time point
    if(dev>(expectedtimer-1000)/2) dev = (expectedtimer-1000)/2; //If deviation is too big, at least make the deviation so that the next timer falls into the second half towards the expected time
    var timer = Math.floor(expectedtimer-dev+(Math.random()*2*dev)); //Real timer until data gathering, in seconds
    var minutes, seconds;
        var remainingtimesecs = Math.floor(remainingtime/1000);
        minutes = parseInt(remainingtimesecs / 60, 10)
        seconds = parseInt(remainingtimesecs % 60, 10);
        minutes = minutes < 10 ? "0" + minutes : minutes;
        seconds = seconds < 10 ? "0" + seconds : seconds;
//        display.textContent = minutes + ":" + seconds;
//        display2.textContent = ""+datasofar;

        var pretitle = document.title.substring(document.title.indexOf(" | "));
        //update also the title
        document.title = minutes + ":" + seconds + " " + pretitle;

        return timer;
}

function startTimer(duration, display, display2, linkurl, datasofar) {
    var timer = duration, minutes, seconds;
    var link = document.getElementById('link');
    link.href = linkurl;

    //alert("starting timer for "+duration);
    timersecs = Math.floor(timer/1000);

    intervalTimer = setInterval(myTimer, 1000);
}


function myTimer() {
    remainingtime = endtime - (new Date()).getTime();
    var remainsecs = Math.floor(remainingtime/1000);
    minutes = parseInt(remainsecs / 60, 10)
    seconds = parseInt(remainsecs % 60, 10);
    minutes = minutes < 10 ? "0" + minutes : minutes;
    seconds = seconds < 10 ? "0" + seconds : seconds;
    display.textContent = minutes + ":" + seconds;
    var pretitle = document.title.substring(document.title.indexOf(" | "));
    //update also the title
    document.title = minutes + ":" + seconds + " " + pretitle;

    display2.textContent = ""+datasofar;

    var current = (new Date()).getTime();
    var prop = (current-lasttime)/(nexttime-lasttime);
    if(prop > startTrans && prop < endTrans){
        displayqr.style.opacity = 1+((startTrans-prop)/(endTrans-startTrans));
    }else if(prop>endTrans){
        displayqr.style.opacity = 0;
        displayqr.style.display = 'none';
    }

    if (--timersecs < 0) {
        //document.getElementById('alarm').play();
        playSound('alarm');
        datasofar++;
        displayqr.style.display='block';
        displayqr.style.opacity=1;
        if(datasofar<times){
            clearInterval(intervalTimer);
            var next = setupNextTimer(endtime, display, display2, (times-datasofar), devtime, url);
            startTimer(next, display, display2, url, datasofar);
            lasttime = (new Date()).getTime();
            nexttime = (new Date()).getTime()+next;//Expected timestamp to finish the next timer
        }else{//No more data needed, we wait until time is over
            clearInterval(intervalTimer);
            startTimer(remainingtime, display, display2, url, datasofar);
            lasttime = (new Date()).getTime();
            nexttime = endtime;//Expected timestamp to finish the next timer
            //display.textContent = "No more data needed, waiting until experiment is over";
        }
    }
    if(remainingtime<=0){
        displayqr.style.display = "none";
        clearInterval(intervalTimer);
        document.body.style.backgroundColor = "red";
        displayoverall.textContent = "Experiment is over!";
    }
}

function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}

function isURL(str) {
  var pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
  '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.?)+[a-z]{2,}|'+ // domain name
  '((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
  '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
  '(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
  '(\\#[-a-z\\d_]*)?$','i'); // fragment locator
  return pattern.test(str);
}

//Global variables
var times = 6; // Data gathering points
var totaltime = 75*60; //Total experiment time in seconds
var devtime = Math.floor(totaltime/(2*(times+1))); //range around the regular time point, where the data gathering can happen, in seconds
var display = document.querySelector('#timeleft');
var display2 = document.querySelector('#datasofarmsg');
var displayinitial = document.querySelector('#initialmsg');
var displayqr = document.querySelector('#qr');
var displayoverall = document.querySelector('#message');

var datasofar = 0; // Number of data gathering events fired so far
var url = "https://goo.gl/FqZexS";

//Setup where the end of the experiment will fall (updated later when user clicks start button)
var endtime = (new Date()).getTime()+(totaltime*1000); //timestamp of the endtime
var remainingtime = 0; //Time till the end of experiment, in ms
var timersecs; //Timer that will decrease each time we gather data
var nexttime = endtime; //Time when the next timer is expected to go off (will change later)
var lasttime = (new Date()).getTime();//Time the last timer went off
var intervalTimer; //Interval variable to check whether the time has gone off
var startTrans = 0.5;//Percentage of each timer where we start fading out the qr/link
var endTrans = 0.75;//Percentage of each timer where we disappear the qr/link



window.onload = function () {

//Potential fix?
for (var i = 0; i < audioElements.length; i++) {
    sounds[audioElements[i].className] = audioElements[i];
}
// Solves chrome for andriod issue 178297 Require user gesture
// https://code.google.com/p/chromium/issues/detail?id=178297
// Fix based on code from http://blog.foolip.org/2014/02/10/media-playback-restrictions-in-blink/
if (mediaPlaybackRequiresUserGesture()) {
    window.addEventListener('keydown', removeBehaviorsRestrictions);
    window.addEventListener('mousedown', removeBehaviorsRestrictions);
    window.addEventListener('touchstart', removeBehaviorsRestrictions);
}
///////////////


    // Number of data gathering points/alarms
    if(parseInt(getParameterByName('times'))>0){
        times = parseInt(getParameterByName('times'));
    }

    // Total time of the experiment, in seconds
    if(parseInt(getParameterByName('totalmin'))>0){
        totaltime = parseInt(getParameterByName('totalmin'))*60;
    }

    // Deviation around expected point, in seconds
    if(parseInt(getParameterByName('devmin'))>0){
        devtime = parseInt(getParameterByName('devmin'))*60;
    }

    if(getParameterByName('url')!=null && isURL(decodeURIComponent(getParameterByName('url')))){
        url = decodeURIComponent(getParameterByName('url'));
    }

    var link = document.getElementById('link');
    var link2 = document.getElementById('link2');
    link.href = url;
    link2.href = url;


    //Update the display till the end of the experiment
    minutes = parseInt(totaltime / 60, 10)
    seconds = parseInt(totaltime % 60, 10);
    minutes = minutes < 10 ? "0" + minutes : minutes;
    seconds = seconds < 10 ? "0" + seconds : seconds;
    display.textContent = minutes + ":" + seconds;
    display2.textContent = ""+datasofar;
    displayqr.style.display = "none";

    document.getElementById('button').onclick=function(){
        endtime = (new Date()).getTime()+(totaltime*1000); //timestamp of the endtime, now for real
        //Randomly decide where the next data gathering point will fall, in seconds
        var nextTimer = setupNextTimer(endtime, display, display2, (times-datasofar), devtime, url);
        document.getElementById('alarm').play();
        startTimer(nextTimer, display, display2, url, datasofar);
        lasttime = (new Date()).getTime();
        nexttime = (new Date()).getTime()+nextTimer;//Expected timestamp to finish the next timer
        document.getElementById('button').disabled = true;
        document.getElementById('initialmsg').style.display = 'none';}
};
</script>

<audio preload='preload' id='alarm' class='alarm'>
        <source src='media/alarm.ogg' type='audio/ogg' />
        <source src='media/alarm.mp3' type='audio/mpeg' />
        <source src='media/alarm.wav' type='audio/wav' />
</audio>

  </body>
</html>
